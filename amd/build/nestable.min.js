define(["jquery"],function(){!function(a,b,c,d){function e(b,e){this.w=a(c),this.el=a(b),e=e||h,e.rootClass!==d&&"dd"!==e.rootClass&&(e.listClass=e.listClass?e.listClass:e.rootClass+"-list",e.itemClass=e.itemClass?e.itemClass:e.rootClass+"-item",e.dragClass=e.dragClass?e.dragClass:e.rootClass+"-dragel",e.handleClass=e.handleClass?e.handleClass:e.rootClass+"-handle",e.collapsedClass=e.collapsedClass?e.collapsedClass:e.rootClass+"-collapsed",e.placeClass=e.placeClass?e.placeClass:e.rootClass+"-placeholder",e.noDragClass=e.noDragClass?e.noDragClass:e.rootClass+"-nodrag",e.noChildrenClass=e.noChildrenClass?e.noChildrenClass:e.rootClass+"-nochildren",e.emptyClass=e.emptyClass?e.emptyClass:e.rootClass+"-empty"),this.options=a.extend({},h,e),this.options.json!==d&&this._build(),this.init()}var f="ontouchstart"in c,g=function(){var a=c.createElement("div"),d=c.documentElement;if(!("pointerEvents"in a.style))return!1;a.style.pointerEvents="auto",a.style.pointerEvents="x",d.appendChild(a);var e=b.getComputedStyle&&"auto"===b.getComputedStyle(a,"").pointerEvents;return d.removeChild(a),!!e}(),h={contentCallback:function(a){return a.content?a.content:a.id},listNodeName:"ol",itemNodeName:"li",handleNodeName:"div",contentNodeName:"span",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",contentClass:"dd-content",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noChildrenClass:"dd-nochildren",emptyClass:"dd-empty",expandBtnHTML:'<button class="dd-expand" data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button class="dd-collapse" data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,fixedDepth:!1,fixed:!1,includeContent:!1,scroll:!1,scrollSensitivity:1,scrollSpeed:5,scrollTriggers:{top:40,left:40,right:-40,bottom:-40},effect:{animation:"none",time:"slow"},callback:function(a,b,c){},onDragStart:function(a,b,c){},beforeDragStop:function(a,b,c){},listRenderer:function(a,b){var c="<"+b.listNodeName+' class="'+b.listClass+'">';return c+=a,c+="</"+b.listNodeName+">"},itemRenderer:function(b,c,d,e,f){var g=a.map(b,function(a,b){return" "+b+'="'+a+'"'}).join(" "),h="<"+e.itemNodeName+g+">";return h+="<"+e.handleNodeName+' class="'+e.handleClass+'">',h+="<"+e.contentNodeName+' class="'+e.contentClass+'">',h+=c,h+="</"+e.contentNodeName+">",h+="</"+e.handleNodeName+">",h+=d,h+="</"+e.itemNodeName+">"}};e.prototype={init:function(){var c=this;c.reset(),c.el.data("nestable-group",this.options.group),c.placeEl=a('<div class="'+c.options.placeClass+'"/>');var d=this.el.find(c.options.itemNodeName);a.each(d,function(b,d){var e=a(d),f=e.parent();c.setParent(e),f.hasClass(c.options.collapsedClass)&&c.collapseItem(f.parent())}),d.length||this.appendEmptyElement(this.el),c.el.on("click","button",function(b){if(!c.dragEl){var d=a(b.currentTarget),e=d.data("action"),f=d.parents(c.options.itemNodeName).eq(0);"collapse"===e&&c.collapseItem(f),"expand"===e&&c.expandItem(f)}});var e=function(b){var d=a(b.target);if(!d.hasClass(c.options.handleClass)){if(d.closest("."+c.options.noDragClass).length)return;d=d.closest("."+c.options.handleClass)}d.length&&!c.dragEl&&(c.isTouch=/^touch/.test(b.type),c.isTouch&&1!==b.touches.length||c.dragStart(b.touches?b.touches[0]:b))},g=function(a){c.dragEl&&(a.preventDefault(),c.dragMove(a.touches?a.touches[0]:a))},h=function(a){c.dragEl&&(a.preventDefault(),c.dragStop(a.touches?a.changedTouches[0]:a))};f&&(c.el[0].addEventListener("touchstart",e,!1),b.addEventListener("touchmove",g,!1),b.addEventListener("touchend",h,!1),b.addEventListener("touchcancel",h,!1)),c.el.on("mousedown",e),c.w.on("mousemove",g),c.w.on("mouseup",h);var i=function(){f&&(c.el[0].removeEventListener("touchstart",e,!1),b.removeEventListener("touchmove",g,!1),b.removeEventListener("touchend",h,!1),b.removeEventListener("touchcancel",h,!1)),c.el.off("mousedown",e),c.w.off("mousemove",g),c.w.off("mouseup",h),c.el.off("click"),c.el.unbind("destroy-nestable"),c.el.data("nestable",null)};c.el.bind("destroy-nestable",i)},destroy:function(){this.el.trigger("destroy-nestable")},add:function(b){var c="."+this.options.listClass,e=a(this.el).children(c);b.parent_id!==d&&(e=e.find('[data-id="'+b.parent_id+'"]'),delete b.parent_id,0===e.children(c).length&&(e=e.append(this.options.listRenderer("",this.options))),e=e.find(c+":first"),this.setParent(e.parent())),e.append(this._buildItem(b,this.options))},replace:function(a){var b=this._buildItem(a,this.options);this._getItemById(a.id).replaceWith(b)},removeItem:function(b){var c=this.options,d=this.el;b=b||this,b.remove();var e="."+c.listClass+" ."+c.listClass+":not(:has(*))";a(d).find(e).remove();var f='[data-action="expand"], [data-action="collapse"]';a(d).find(f).each(function(){var b=a(this).siblings("."+c.listClass);0===b.length&&a(this).remove()})},remove:function(a,b){var c=this.options,d=this,e=this._getItemById(a),f=c.effect.animation||"fade",g=c.effect.time||"slow";"fade"===f?e.fadeOut(g,function(){d.removeItem(e)}):this.removeItem(e),b&&b()},removeAll:function(b){function c(){g.each(function(){d.removeItem(a(this))}),f.show(),b&&b()}var d=this,e=this.options,f=d.el.find(e.listNodeName).first(),g=f.children(e.itemNodeName),h=e.effect.animation||"fade",i=e.effect.time||"slow";"fade"===h?f.fadeOut(i,c):c()},_getItemById:function(b){return a(this.el).children("."+this.options.listClass).find('[data-id="'+b+'"]')},_build:function(){var b=this.options.json;"string"==typeof b&&(b=JSON.parse(b)),a(this.el).html(this._buildList(b,this.options))},_buildList:function(b,c){if(!b)return"";var d="",e=this;return a.each(b,function(a,b){d+=e._buildItem(b,c)}),c.listRenderer(d,c)},_buildItem:function(b,c){function d(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a+"".replace(/[&<>"']/g,function(a){return b[a]})}function e(a){var b={};for(var c in a)b[a[c]]=a[c];return b}function f(b,c){var d=b.classes||{};"string"==typeof d&&(d=[d]);var f=e(d);return f[c.itemClass]=c.itemClass,a.map(f,function(a){return a}).join(" ")}function g(b){b=a.extend({},b),delete b.children,delete b.classes,delete b.content;var c={};return a.each(b,function(a,b){"object"==typeof b&&(b=JSON.stringify(b)),c["data-"+a]=d(b)}),c}var h=g(b);h["class"]=f(b,c);var i=c.contentCallback(b),j=this._buildList(b.children,c),k=a(c.itemRenderer(h,i,j,c,b));return this.setParent(k),k[0].outerHTML},serialize:function(){var b,c=this,d=function(b){var e=[],f=b.children(c.options.itemNodeName);return f.each(function(){var b=a(this),f=a.extend({},b.data()),g=b.children(c.options.listNodeName);if(c.options.includeContent){var h=b.find("."+c.options.contentClass).html();h&&(f.content=h)}g.length&&(f.children=d(g)),e.push(f)}),e};return b=d(c.el.find(c.options.listNodeName).first())},asNestedSet:function(){function b(d,f,h){var i,j,k=h+1;return a(d).children(e.listNodeName).children(e.itemNodeName).length>0&&(f++,a(d).children(e.listNodeName).children(e.itemNodeName).each(function(){k=b(a(this),f,k)}),f--),i=a(d).attr("data-id"),c(i)&&(i=parseInt(i)),j=a(d).parent(e.listNodeName).parent(e.itemNodeName).attr("data-id")||"",c(j)&&(j=parseInt(j)),i&&g.push({id:i,parent_id:j,depth:f,lft:h,rgt:k}),h=k+1}function c(b){return a.isNumeric(b)&&Math.floor(b)==b}var d=this,e=d.options,f=-1,g=[],h=1,i=d.el.find(e.listNodeName).first().children(e.itemNodeName);return i.each(function(){h=b(this,f+1,h)}),g=g.sort(function(a,b){return a.lft-b.lft})},returnOptions:function(){return this.options},serialise:function(){return this.serialize()},toHierarchy:function(b){function c(b){var e=(a(b).attr(d.attribute||"id")||"").match(d.expression||/(.+)[-=_](.+)/);if(e){var f={id:e[2]};return a(b).children(d.listType).children(d.items).length>0&&(f.children=[],a(b).children(d.listType).children(d.items).each(function(){var a=c(this);f.children.push(a)})),f}}var d=a.extend({},this.options,b),e=[];return a(this.element).children(d.items).each(function(){var a=c(this);e.push(a)}),e},toArray:function(){function b(f,g,h){var i,j,k=h+1;if(f.children(c.options.listNodeName).children(c.options.itemNodeName).length>0&&(g++,f.children(c.options.listNodeName).children(c.options.itemNodeName).each(function(){k=b(a(this),g,k)}),g--),i=f.data().id,g===d+1)j=c.rootID;else{var l=f.parent(c.options.listNodeName).parent(c.options.itemNodeName).data();j=l.id}return i&&e.push({id:i,parent_id:j,depth:g,left:h,right:k}),h=k+1}var c=a.extend({},this.options,this),d=c.startDepthCount||0,e=[],f=2,g=this,h=g.el.find(g.options.listNodeName).first(),i=h.children(g.options.itemNodeName);return i.each(function(){f=b(a(this),d+1,f)}),e=e.sort(function(a,b){return a.left-b.left})},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(a){a.removeClass(this.options.collapsedClass)},collapseItem:function(a){var b=a.children(this.options.listNodeName);b.length&&a.addClass(this.options.collapsedClass)},expandAll:function(){var b=this;b.el.find(b.options.itemNodeName).each(function(){b.expandItem(a(this))})},collapseAll:function(){var b=this;b.el.find(b.options.itemNodeName).each(function(){b.collapseItem(a(this))})},setParent:function(b){b.is(this.options.itemNodeName)&&b.children(this.options.listNodeName).length&&(b.children("[data-action]").remove(),b.prepend(a(this.options.expandBtnHTML)),b.prepend(a(this.options.collapseBtnHTML)))},unsetParent:function(a){a.removeClass(this.options.collapsedClass),a.children("[data-action]").remove(),a.children(this.options.listNodeName).remove()},dragStart:function(b){var d=this.mouse,e=a(b.target),f=e.closest(this.options.itemNodeName),g={top:b.pageY,left:b.pageX},h=this.options.onDragStart.call(this,this.el,f,g);if("undefined"==typeof h||h!==!1){this.placeEl.css("height",f.height()),d.offsetX=b.pageX-f.offset().left,d.offsetY=b.pageY-f.offset().top,d.startX=d.lastX=b.pageX,d.startY=d.lastY=b.pageY,this.dragRootEl=this.el,this.dragEl=a(c.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",f.outerWidth()),this.setIndexOfItem(f),f.after(this.placeEl),f[0].parentNode.removeChild(f[0]),f.appendTo(this.dragEl),a(c.body).append(this.dragEl),this.dragEl.css({left:b.pageX-d.offsetX,top:b.pageY-d.offsetY});var i,j,k=this.dragEl.find(this.options.itemNodeName);for(i=0;i<k.length;i++)j=a(k[i]).parents(this.options.listNodeName).length,j>this.dragDepth&&(this.dragDepth=j)}},createSubLevel:function(b,c){var d=a("<"+this.options.listNodeName+"/>").addClass(this.options.listClass);return c&&d.append(c),b.append(d),this.setParent(b),d},setIndexOfItem:function(b,c){c=c||[],c.unshift(b.index()),a(b[0].parentNode)[0]!==this.dragRootEl[0]?this.setIndexOfItem(a(b[0].parentNode),c):this.dragEl.data("indexOfItem",c)},restoreItemAtIndex:function(b,c){function d(b,d){0===c[f]?a(b).prepend(d.clone(!0)):a(b.children[c[f]-1]).after(d.clone(!0))}for(var e=this.el,f=c.length-1,g=0;g<c.length;g++){if(f===parseInt(g))return void d(e,b);var h=e[0]?e[0]:e,i=h.children[c[g]];e=i?i:this.createSubLevel(a(h))}},dragStop:function(a){var b={top:a.pageY,left:a.pageX},c=this.dragEl.data("indexOfItem"),d=this.dragEl.children(this.options.itemNodeName).first();d[0].parentNode.removeChild(d[0]),this.dragEl.remove();var e=this.options.beforeDragStop.call(this,this.el,d,this.placeEl.parent());if("undefined"!=typeof e&&e===!1){var f=this.placeEl.parent();return this.placeEl.remove(),f.children().length||this.unsetParent(f.parent()),this.restoreItemAtIndex(d,c),void this.reset()}this.placeEl.replaceWith(d),this.hasNewRoot?(this.options.fixed===!0?this.restoreItemAtIndex(d,c):this.el.trigger("lostItem"),this.dragRootEl.trigger("gainedItem")):this.dragRootEl.trigger("change"),this.options.callback.call(this,this.dragRootEl,d,b),this.reset()},dragMove:function(d){var e,f,h,i,j,k=this.options,l=this.mouse;this.dragEl.css({left:d.pageX-l.offsetX,top:d.pageY-l.offsetY}),l.lastX=l.nowX,l.lastY=l.nowY,l.nowX=d.pageX,l.nowY=d.pageY,l.distX=l.nowX-l.lastX,l.distY=l.nowY-l.lastY,l.lastDirX=l.dirX,l.lastDirY=l.dirY,l.dirX=0===l.distX?0:l.distX>0?1:-1,l.dirY=0===l.distY?0:l.distY>0?1:-1;var m=Math.abs(l.distX)>Math.abs(l.distY)?1:0;if(!l.moving)return l.dirAx=m,void(l.moving=!0);if(k.scroll)if("undefined"!=typeof b.jQuery.fn.scrollParent){var n=!1,o=this.el.scrollParent()[0];o!==c&&"HTML"!==o.tagName?(k.scrollTriggers.bottom+o.offsetHeight-d.pageY<k.scrollSensitivity?o.scrollTop=n=o.scrollTop+k.scrollSpeed:d.pageY-k.scrollTriggers.top<k.scrollSensitivity&&(o.scrollTop=n=o.scrollTop-k.scrollSpeed),k.scrollTriggers.right+o.offsetWidth-d.pageX<k.scrollSensitivity?o.scrollLeft=n=o.scrollLeft+k.scrollSpeed:d.pageX-k.scrollTriggers.left<k.scrollSensitivity&&(o.scrollLeft=n=o.scrollLeft-k.scrollSpeed)):(d.pageY-a(c).scrollTop()<k.scrollSensitivity?n=a(c).scrollTop(a(c).scrollTop()-k.scrollSpeed):a(b).height()-(d.pageY-a(c).scrollTop())<k.scrollSensitivity&&(n=a(c).scrollTop(a(c).scrollTop()+k.scrollSpeed)),d.pageX-a(c).scrollLeft()<k.scrollSensitivity?n=a(c).scrollLeft(a(c).scrollLeft()-k.scrollSpeed):a(b).width()-(d.pageX-a(c).scrollLeft())<k.scrollSensitivity&&(n=a(c).scrollLeft(a(c).scrollLeft()+k.scrollSpeed)))}else console.warn("To use scrolling you need to have scrollParent() function, check documentation for more information");this.scrollTimer&&clearTimeout(this.scrollTimer),k.scroll&&n&&(this.scrollTimer=setTimeout(function(){a(b).trigger(d)},10)),l.dirAx!==m?(l.distAxX=0,l.distAxY=0):(l.distAxX+=Math.abs(l.distX),0!==l.dirX&&l.dirX!==l.lastDirX&&(l.distAxX=0),l.distAxY+=Math.abs(l.distY),0!==l.dirY&&l.dirY!==l.lastDirY&&(l.distAxY=0)),l.dirAx=m,l.dirAx&&l.distAxX>=k.threshold&&(l.distAxX=0,h=this.placeEl.prev(k.itemNodeName),l.distX>0&&h.length&&!h.hasClass(k.collapsedClass)&&!h.hasClass(k.noChildrenClass)&&(e=h.find(k.listNodeName).last(),j=this.placeEl.parents(k.listNodeName).length,j+this.dragDepth<=k.maxDepth&&(e.length?(e=h.children(k.listNodeName).last(),e.append(this.placeEl)):this.createSubLevel(h,this.placeEl))),l.distX<0&&(i=this.placeEl.next(k.itemNodeName),i.length||(f=this.placeEl.parent(),this.placeEl.closest(k.itemNodeName).after(this.placeEl),f.children().length||this.unsetParent(f.parent()))));var p=!1;if(g||(this.dragEl[0].style.visibility="hidden"),this.pointEl=a(c.elementFromPoint(d.pageX-c.body.scrollLeft,d.pageY-(b.pageYOffset||c.documentElement.scrollTop))),g||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(k.handleClass)&&(this.pointEl=this.pointEl.closest(k.itemNodeName)),this.pointEl.hasClass(k.emptyClass))p=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(k.itemClass))return;var q=this.pointEl.closest("."+k.rootClass),r=this.dragRootEl.data("nestable-id")!==q.data("nestable-id");if(!l.dirAx||r||p){if(r&&k.group!==q.data("nestable-group"))return;if(this.options.fixedDepth&&this.dragDepth+1!==this.pointEl.parents(k.listNodeName).length)return;if(j=this.dragDepth-1+this.pointEl.parents(k.listNodeName).length,j>k.maxDepth)return;var s=d.pageY<this.pointEl.offset().top+this.pointEl.height()/2;f=this.placeEl.parent(),p?(e=a(c.createElement(k.listNodeName)).addClass(k.listClass),e.append(this.placeEl),this.pointEl.replaceWith(e)):s?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),f.children().length||this.unsetParent(f.parent()),this.dragRootEl.find(k.itemNodeName).length||this.appendEmptyElement(this.dragRootEl),this.dragRootEl=q,r&&(this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}},appendEmptyElement:function(a){a.append('<div class="'+this.options.emptyClass+'"/>')}},a.fn.nestable=function(c){var d=this,f=this,g=arguments;return"Nestable"in b||(b.Nestable={},Nestable.counter=0),d.each(function(){var b=a(this).data("nestable");if(b){if("string"==typeof c&&"function"==typeof b[c])if(g.length>1){for(var d=[],h=1;h<g.length;h++)d.push(g[h]);f=b[c].apply(b,d)}else f=b[c]()}else Nestable.counter++,a(this).data("nestable",new e(this,c)),a(this).data("nestable-id",Nestable.counter)}),f||d}}(window.jQuery||window.Zepto,window,document)});