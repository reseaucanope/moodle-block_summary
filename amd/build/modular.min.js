define(["block_summary/nestable","block_summary/tooltipster","jqueryui"],function(){function a(){var a=null,c="hascontent",d="hasnav",e=!1,f=[];$(".dd").nestable({maxDepth:3,handleClass:"dd-itemdiv",expandBtnHTML:"",collapseBtnHTML:"",group:1,onDragStart:function(b,c,d){var e=$(c).find(".dd-div").first(),f=e.offset(),g=e.width(),h=e.height();return!(d.left<f.left||d.left>f.left+g||d.top<f.top||d.top>f.top+h)&&void(a=c.parents("ol:first").parent("li").children(".dd-itemdiv:first"))},beforeDragStop:function(b,f,g){var h=g[0],i=$(g[0]).closest(".section-part[data-type='module']").length>0;if(a&&a.parents(".section-part[data-type='module']").length&&0==a.next("ol").length&&(a.find("."+d).next(".dd-buttonsblockspacer").remove(),a.find("."+d).remove(),a.find("."+c).remove(),a.find(".dd-handle").removeClass("dd-handle-parent")),a=null,i){h=$(h).prev(".dd-itemdiv");var j=$(f),k=j.find(".dd-itemdiv"),l=h.add(k);l.each(function(){if($(this).next("ol").length>0&&0==$(this).find("."+c).length){var a=$("<span>").addClass("dd-buttonsblockspacer"),b=$("<button>").addClass("fa "+c);$(this).find(".dd-buttonsblock").prepend(a,b),$(this).find(".dd-handle").addClass("dd-handle-parent");var d={maxWidth:620,position:"bottom-right",timer:3e3};d.content=$("<span>Section avec contenu</span>"),$(".hascontent").not(".nocontent").tooltipster(d)}});var m=$("<button>").addClass(d+" fa-stack");m.append($("<span>").addClass("fa fa-sort fa-rotate-90 fa-stack-1x"));var n=k.first();0==h.length&&k.length>1&&0==n.find(".hasnav").length&&n.find(".dd-buttonsblock").prepend(m);var o=h.parents("ol");h&&1!=o.length||0==h.find("."+d).length&&h.find(".dd-buttonsblock").prepend(m);var p=n.find(".hasnav");console.log(p),console.log(h),h.length&&p.length&&(p.next().remove(),p.remove())}else $(f).find("."+c).next(".dd-buttonsblockspacer").remove(),$(f).find("."+c).remove(),$(f).find("."+d).remove();e=!0}}),$(".ishidden").parents("div.dd-itemdiv").addClass("hideClass"),$(".dd").on("click",".hide",function(){$(this).hasClass("ishidden")?($(this).toggleClass("ishidden",!1),$(this).addClass("fa-eye"),$(this).removeClass("fa-eye-slash"),$(this).tooltipster("content",$("<span>Masquer la section</span>")),$(this).parents("div.dd-itemdiv").removeClass("hideClass")):($(this).toggleClass("ishidden",!0),$(this).removeClass("fa-eye"),$(this).addClass("fa-eye-slash"),$(this).tooltipster("content",$("<span>Afficher la section</span>")),$(this).parents("div.dd-itemdiv").addClass("hideClass")),e=!0}),$(".dd").on("click",".hascontent",function(){$(this).hasClass("nocontent")?($(this).removeClass("nocontent"),$(this).tooltipster("content",$("<span>Section avec contenu</span>"))):($(this).addClass("nocontent"),$(this).tooltipster("content",$("<span>Section sans contenu</span>"))),e=!0}),$(".dd").on("click",".hasnav",function(){$(this).hasClass("nonav")?($(this).removeClass("nonav fa fa-slash fa-stack-1x"),$(this).tooltipster("content",$("<span>Module navigable</span>"))):($(this).addClass("nonav"),$(this).addClass("fa fa-slash fa-stack-1x"),$(this).tooltipster("content",$("<span>Module non navigable</span>"))),e=!0});var g=-1;$("#addsection").on("click",function(a){a.preventDefault();var b=$(".section-part[data-type='module']>ol");b.length||($(".section-part[data-type='module']").append($("<ol>").attr("class","dd-list")),$(".section-part[data-type='module'] .dd-empty").remove()),$(".section-part[data-type='module']>ol").append(h(g)),g--;var c={maxWidth:620,position:"bottom-right",timer:3e3};c.content=$("<span>Edition du titre de la section</span>"),$(".edit").tooltipster(c),c.content=$("<span>Masquer la section</span>"),$(".hide:not(.ishidden)").tooltipster(c),c.content=$("<span>Afficher la section</span>"),$(".ishidden").tooltipster(c),c.content=$("<span>Suppression de la section</span>"),$(".del").tooltipster(c),c.content=$("<span>Déplacer la section</span>"),$(".move").tooltipster(c),e=!0});var h=function(a){var b=$("<li>").attr("class","dd-item").attr("data-id",a),c=$("<div>").addClass("dd-itemdiv"),d=$("<div>").addClass("dd-div").append(dd_drag_button),e="Nouvelle section",f=$("<div>").addClass("dd-handle").append(e),g=$("<div>").addClass("dd-buttonsblock").append(dd_buttons);return c.append(d,f,g),b.append(c)};$("form#form").submit(function(){$(window).unbind("beforeunload")}),$("#save").on("click",function(a){a.preventDefault();var c=b($(".block_summary"));if($("#treedata").val(JSON.stringify(c)),$("#isSubmited").val(!0),f.length>0){for($("#dialog-confirm-save-list").empty(),i=0;i<f.length;i++)$("#dialog-confirm-save-list").append("<li>"+f[i]+"</li>");$("#dialog-confirm-save").dialog({resizable:!1,height:"auto",maxHeight:400,width:600,modal:!0,buttons:{Valider:function(){e=!1,$("#form").submit(),$(this).dialog("close")},Annuler:function(){$(this).dialog("close")}}}),$(".ui-dialog-buttonset > button:last").focus(),e=!0}else window.onbeforeunload=null,$("#form").submit()}),$(".dd").on("click",".del",function(){var a=$(this);$("#dialog-confirm").dialog({resizable:!1,height:"auto",width:600,modal:!0,buttons:{"Supprimer la section":function(){var b=a.parents("li").first(),c=b.attr("data-numsection"),d=b.find("div.dd-handle")[0].textContent;f.push("Section "+c+" : "+d),b.find("li").toArray().map(function(a){var b=$(a),c=b.attr("data-numsection"),d=b.find("div.dd-handle")[0].textContent;f.push("Section "+c+" : "+d)}),a.parents("ol").first().children().length<=1&&$(".dd").nestable("unsetParent",a.parents("ol").first().parents("li").first()),a.parents("li").first().remove(),$(this).dialog("close")},Annuler:function(){$(this).dialog("close")}}}),e=!0}),$(".dd").on("keyup",".editinput",function(a){13==a.keyCode&&$(this).trigger("focusout")}),$(".dd").on("focusout",".editinput",function(){var a=$(this).parent(),b=a.parent().children(".dd-buttonsblock").children(".edit");b.removeClass("fa-check"),b.addClass("fa-pencil");var c=a.children().first().val();a.empty(),a.append(c)}),$(".dd").on("click",".edit",function(){var a=$(this).parents("li"),b=a.first().children(".dd-itemdiv").first().children(".dd-handle").first(),c=a.attr("data-id");if($(this).hasClass("fa-pencil")){$(this).removeClass("fa-pencil"),$(this).addClass("fa-check");var d=$.trim(b.text()),f=$("<input>");f.attr("class","editinput"),f.attr("id",c+"_input"),f.attr("value",d),f.attr("type","text"),b.empty(),b.append(f),b.find("#"+c+"_input").focus()}else{$(this).removeClass("fa-check"),$(this).addClass("fa-pencil");var d=b.children().first().val();b.empty(),b.append(d)}e=!0});var j={maxWidth:620,position:"bottom-right",timer:3e3};j.content=$("<span>Edition du titre de la section</span>"),$(".edit").tooltipster(j),j.content=$("<span>Masquer la section</span>"),$(".hide:not(.ishidden)").tooltipster(j),j.content=$("<span>Afficher la section</span>"),$(".ishidden").tooltipster(j),j.content=$("<span>Suppression de la section</span>"),$(".del").tooltipster(j),j.content=$("<span>Déplacer la section</span>"),$(".move").tooltipster(j),j.content=$("<span>Section avec contenu</span>"),$(".hascontent").not(".nocontent").tooltipster(j),j.content=$("<span>Section sans contenu</span>"),$(".nocontent").tooltipster(j),j.content=$("<span>Module navigable</span>"),$(".hasnav").tooltipster(j),j.content=$("<span>Module non navigable</span>"),$(".nonav").tooltipster(j),$(window).on("beforeunload",function(a){if(e)return a=a||window.event,a&&(a.returnValue="There is some unsaved changes!"),"There is some unsaved changes!"})}function b(a){var b=[],c=[],d=function(a,e){var f=[],g=a.children("li");return g.each(function(){var a=$(this),f=$.extend({},a.data()),g=a.children("ol");c.push(f),f.children=[],g.length&&(f.children=d(g,f.id)),f.name=$(this).find(".dd-handle:first").text(),f.visible=!$(this).find(".hide:first").hasClass("ishidden"),f.hasContent=!($(this).children(".dd-itemdiv").find(".nocontent").length>0),f.type=$(this).parents(".section-part").attr("data-type"),f.parentid=e?e:null,f.hasNavigation=$(this).find(".hasnav:first").hasClass("nonav")?0:1,f.id>0&&b.push(f.id)}),f},e={nodes:c,ids:b};return a.find(".section-part>ol").each(function(){d($(this))}),e}return{init:function(){a()}}});